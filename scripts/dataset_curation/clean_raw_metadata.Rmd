---
title: "Data Cleaning Step 1 - Curate raw MERLIN metadata (Positive_ND_Isolates_Sent_to_MI_comb_sensi_etest_*.xlsx)"
author: "Kyle Gontjes"
output: html_document
date: "`r Sys.Date()`"
---

Notes:

1.  Received new data on 03/20/25

2.  Received update with plate data on 3/27/25

3.  Received update with final plate data on 4/01/25

4.  Fix 168H location_or_participant variable to match SRA metadata on 10/7/25

5.  Received update on 10/30/25:

-   A. Dropped 3 isolates as previously discussed

-   B. Changed LV S-numbers for 4 isolates as previously discussed

-   C. Location_or_participant 1hs changed to 1hf1

-   D. Location_or_participant 100hs changed to 100hf1

-   E. For household 168H: location_or_participant changed from 166hf1 to 168hf1

-   F. Removed notes in parentheses from isolate_id

```{r setup, include=FALSE}
require(knitr)
opts_knit$set(echo = T,warning = FALSE, message = FALSE,error=F,comment=NA) 
opts_chunk$set(echo = T,warning = FALSE, message = FALSE,error=F,comment=NA)
opts_knit$set(root.dir='~/Desktop/gl_merlin/Analysis/Household_transmission/')
```

# Environment

```{r environment, echo=T, message=FALSE, include=T, results=T}
#Packages
packages <- c("tidyverse")   
#Load Packages
invisible(lapply(packages,library,character.only=T,quietly=T))

# Print environment
set.seed(45) 
Sys.info()
sessionInfo()
```

# Load Data

```{r}
metadata <- readxl::read_xlsx('../data/Positive_ND_Isolates_Sent_to_MI_comb_sensi_etest_20251017.xlsx', trim_ws = T)  
metadata <- as.data.frame(metadata) 
```

# Clean Datasets

## Isolate variable

```{r}
# Harmonize isolate ID information
metadata$isolate_id_recode <- metadata$isolate_id
## Petnape -> Pet Nape
metadata$isolate_id_recode <- gsub(pattern = "Petnape", replacement = "Pet Nape", metadata$isolate_id_recode)
## Petstool -> Pet Stool
metadata$isolate_id_recode <- gsub(pattern = "Petstool", replacement = "Pet Stool", metadata$isolate_id_recode)
```

## Household id (correct lowercase)

```{r}
# Correct lowercase
metadata$household_number_recode <- recode(metadata$household_number, '49h' = '49H')
```

# Edit isolates with coding differences in the platemap

## Specifically to enable proper merging with metadata

```{r}
# 113H_2_Pet Stool 1A C1: Remove C1
metadata$isolate_id_recode <- ifelse(metadata$household_number_recode=="113H" & metadata$visit ==2 & metadata$isolate_id == "Pet Stool 1A C1", "Pet Stool 1A", metadata$isolate_id_recode)

# 113H: Add "C1" to Visit 2 Washing Machine  
metadata$isolate_id_recode <- ifelse(metadata$household_number_recode == "113H" & metadata$visit == 2 & metadata$isolate_id == "Washing Machine", "Washing Machine C1", metadata$isolate_id_recode)
 
# 160H: Add "C1" to Visit 1 Bath 1
metadata$isolate_id_recode <- ifelse(metadata$household_number_recode == "160H" & metadata$visit == 1 & metadata$isolate_id == "Bath 1", "Bath 1 C1", metadata$isolate_id_recode)

# 182H: Add "C1" to Visit 3 Bath 1 
metadata$isolate_id_recode <- ifelse(metadata$household_number_recode == "182H" & metadata$visit == 3 & metadata$isolate_id == "Bath 1", "Bath 1 C1", metadata$isolate_id_recode)

# 197H: Add "C1" to Visit 2 Living Room 
metadata$isolate_id_recode <- ifelse(metadata$household_number_recode == "197H" & metadata$visit == 2 & metadata$isolate_id == "Living Room", "Living Room C1", metadata$isolate_id_recode)

# 151H: Remove "C1" from  Visit 3 Living Room & Washing Room
metadata$isolate_id_recode <- ifelse(metadata$household_number_recode == "151H" & metadata$visit == 3 & metadata$isolate_id == "Living Room C1", "Living Room", metadata$isolate_id_recode)

metadata$isolate_id_recode <- ifelse(metadata$household_number_recode == "151H" & metadata$visit == 3 & metadata$isolate_id == "Washing Machine C1", "Washing Machine", metadata$isolate_id_recode)
```

# Save metadata

```{r}
saveRDS(metadata,"./MERLIN-prolonged-colonization-ms/data/dataset/isolate_metadata.RDS")
write_csv(metadata,"./MERLIN-prolonged-colonization-ms/data/dataset/isolate_metadata.csv")
```
