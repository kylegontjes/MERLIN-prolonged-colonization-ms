---
title: "Data Cleaning Step 5 - Add sequencing [QCD] data to de-duplicated metadata"
author: "Kyle Gontjes"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
require(knitr)
knitr::opts_chunk$set(echo = TRUE)
opts_knit$set(root.dir='~/Desktop/gl_merlin/Analysis/Household_transmission/')
```

# Environment
```{r environment, echo=T, message=FALSE, include=T, results=T}
#Packages
packages <- c("tidyverse")   
#Load Packages
invisible(lapply(packages,library,character.only=T,quietly=T))

# Print environment
set.seed(45) 
Sys.info()
sessionInfo()
```

# Load data
```{r}
metadata <- readRDS("./MERLIN-prolonged-colonization-ms/data/dataset/metadata_w_genomic_id_w_duplicate_ESCrE_addressed.RDS") 
qcd <- readRDS("./MERLIN-prolonged-colonization-ms/data/QCD/master_qc_all.RDS")
```

# Merge qcd data
```{r}
# Take the genomic IDs and QC flag entry. Subset to those matching WGS ID and merge by ; values
merge_qcd_data <- function(WGS_id, QC_flag){
  samples <- str_split(WGS_id,";") %>% unlist
  qcd_subset <- qcd %>% subset(Sample %in% samples & qc_pass==QC_flag)
  if(nrow(qcd_subset)>1){
    qcd_subset <- qcd_subset[match(qcd_subset$Sample,samples),]
    qcd_subset <- qcd_subset  %>%
  summarise(across(everything(), ~ paste(unique(.), collapse = ";")), .groups = "drop")
  }
  return(qcd_subset)
}

# Passing genomes
## Preferentially get only the passing ones!
qcd_entries <- lapply(metadata$genomic_id,merge_qcd_data,QC_flag='TRUE') %>% do.call(rbind,.) %>% distinct() 

# Failing genomes
## For those, feel free to mergy them! That's fine, because we don't care about duplicates here
failed_genomes <- metadata %>% subset(WGS_qc_pass_runs_num == 0 ) %>% .$Genome_ID
 
qcd_entries_failed <-  lapply(failed_genomes,merge_qcd_data,QC_flag='FALSE') %>% do.call(rbind,.) %>% distinct()
qcd_results <- rbind(qcd_entries,qcd_entries_failed)

metadata <- left_join(metadata, qcd_results)

# Clean by removing unnecessary columns and update column names
metadata_clean <- metadata %>% select(-no_correct_platemap,-WGS_qc_pass_runs_num,-WGS_qc_pass_ids_num)
colnames(metadata_clean) <- gsub("\\.|\\.\\.\\.","_",colnames(metadata_clean))
```

# Save file
```{r}
saveRDS(metadata_clean,'./MERLIN-prolonged-colonization-ms/data/dataset/metadata_w_genomic_id_w_duplicate_ESCrE_addressed_w_qcd.RDS')
write.csv(metadata_clean,'./MERLIN-prolonged-colonization-ms/data/dataset/metadata_w_genomic_id_w_duplicate_ESCrE_addressed_w_qcd.csv')
```
