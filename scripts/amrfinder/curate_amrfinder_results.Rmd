---
title: "curate_amrfinder_results"
author: "Kyle Gontjes"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
require(knitr)
opts_knit$set(echo = F,warning = FALSE, message = FALSE,error=F,comment=NA) 
opts_chunk$set(echo = F,warning = FALSE, message = FALSE,error=F,comment=NA)
opts_knit$set(root.dir='~/Desktop/gl_merlin/Analysis/Household_transmission/MERLIN-prolonged-colonization-ms/')
```

```{r environment, echo=F, message=FALSE, include=F, results=F}
#Packages
packages <- c("tidyverse") 

#Load Packages
invisible(lapply(packages,library,character.only=T,quietly=T))

# Print environment
set.seed(45) 
Sys.info()
sessionInfo()
```

```{r cars} 
df <- readRDS("./data/dataset/MERLIN_cohort_metadata_final.RDS") 
final_isolates <- subset(df,WGS_escre == TRUE & qc_pass == TRUE) %>% .$genomic_id 
paste0("Number of final isolates that were ESCRE and QC passing: ", length(final_isolates))
```

# create_master_amrfinder_script
```{bash}
cd ./data/amrfinder/

head -n1 MERLIN_100_amrfinder.out  > amrfinder_all.txt
for isolate in `ls *amrfinder.out`
do
echo $isolate
tail -n +2 $isolate >> amrfinder_all.txt
done
```

# load in amrfinder dataset
```{r}
amrfinder <- read.delim(file="./data/amrfinder/amrfinder_all.txt")

amrfinder$genomic_id <- sapply(amrfinder$Contig.id,FUN=function(x){
 x %>% str_split(.,"_") %>% unlist %>% .[1:2] %>% paste0(.,collapse = "_")
})

amrfinder$contig <- sapply(amrfinder$Contig.id,FUN=function(x){
 x %>% str_split(.,"_") %>% unlist %>% .[3]   
})

colnames(amrfinder) <- snakecase::to_snake_case(colnames(amrfinder) ) %>% gsub("x_","",.)

amrfinder <- amrfinder %>% select(-protein_id,-hmm_accession,-hmm_description) 
amrfinder <- subset(amrfinder, genomic_id %in% final_isolates)

saveRDS(amrfinder,file="./data/amrfinder/amrfinder_cleaned.RDS")

get_amrfinder_matrix <- function(amrfinder,isolates){
  unique_genes <- amrfinder$element_symbol %>% unique
  lapply(unique_genes,FUN =function(x,amrfinder){
    isolates_with_gene <-  subset(amrfinder,element_symbol == x) %>% select(genomic_id) %>% unlist
    row <- assign(paste0(x),ifelse(isolates %in% isolates_with_gene,1,0))
    return(row)},amrfinder) %>% do.call(bind_cols,.) %>% as.data.frame %>% `colnames<-`(unique_genes) %>% `rownames<-`(isolates)
}

amrfinder_mat <- get_amrfinder_matrix(amrfinder = amrfinder,isolates = final_isolates)

saveRDS(amrfinder_mat,file="./data/amrfinder/amrfinder_matrix.RDS")
``` 