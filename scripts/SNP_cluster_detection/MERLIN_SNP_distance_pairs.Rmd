---
title: "SNP Clustering Step 2: Generate pairs for SNP distance analyses"
author: "Kyle Gontjes"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
require(knitr)
opts_knit$set(echo = T,warning = FALSE, message = FALSE,error=F,comment=NA) 
opts_chunk$set(echo = T,warning = FALSE, message = FALSE,error=F,comment=NA)
opts_knit$set(root.dir='~/Desktop/gl_merlin/')
```

# Environment

```{r environment, echo=T, message=FALSE, include=T, results=T}
#Packages
packages <- c("tidyverse",'ape','kableExtra','phytools','igraph','ggraph','tableone','kableExtra') 

#Load Packages
invisible(lapply(packages,library,character.only=T,quietly=T))

# Print environment
set.seed(45) 
Sys.info()
sessionInfo()
```

# Load data
```{r} 
df <- readRDS("./Analysis/Household_transmission/MERLIN-prolonged-colonization-ms/data/dataset/metadata_w_genomic_id_w_duplicate_ESCrE_addressed_w_qcd_w_sra_metadata.RDS") %>% subset(WGS_escre==T & qc_pass==T)

paste0("Number of considered isolates: ",nrow(df))
``` 

# Load distances matrices for species with more than one isolate
```{r}
species <- table(df$Species) %>% subset(.>1)  %>% names

species_simple <- str_split(string = species,pattern = " ",simplify = T) %>% apply(.,1,FUN=function(x){
  genus <- x[1] %>% substr(.,1,1)  %>% tolower()
  species <- x[2]
  paste0(genus,species)}) 

dist_matrices <- readRDS('./Analysis/Household_transmission/MERLIN-prolonged-colonization-ms/data/SNP_distance/MERLIN_SNP_distance_matrices.RDS')
```

# Curate metadata to species and isolates of interest 
```{r}
# Subset metadata and matrix to species
clean_datasets <- function(metadata,mat,species){
  # Curate datasets
  ## Species of interest
  species_df <- metadata %>% subset(Species ==species)  
  rownames(species_df) <- species_df$isolate_no
  ## Isolates of interest
  species_mat <- mat[species_df$genomic_id,species_df$genomic_id]
  # Update datasets
  results <- list(species_df,species_mat) %>% `names<-`(c("df","mat"))
  return(results)
}

# Curate metadata
for(i in species){
  species_abrev <- str_split(string = i,pattern = " ",simplify = T) %>% apply(.,1,FUN=function(x){
  genus <- x[1] %>% substr(.,1,1)  %>% tolower()
  species <- x[2]
  paste0(genus,species)}) 
  assign(paste0(species_abrev,"_data"),
       clean_datasets(df,dist_matrices[[species_abrev]],species = i))
} 
```

# Get pairwise distances
## Get distance data (i.e., info for each cell) [This is MUCH quicker than other methods like regentrans]
```{r}
get_cell_info <- function(mat) {
  idx <- which(!is.na(mat) & lower.tri(mat) , arr.ind = TRUE)
  data.frame(
    isolate1 = rownames(mat)[idx[, 1]],
    isolate2 = colnames(mat)[idx[, 2]],
    pairwise_dist = mat[idx]
  )
}
```

## Get pair types matrix with updated info (i.e., info for each member of the pair)
```{r}
get_pair_types_mat <- function(dataset,mat,type,voi){ 
  pair_types <- get_cell_info(mat = mat)
  pair_types_info <-  update_pair_types_w_info(pair_types,df=dataset,voi=voi) 
  pair_types_df <- left_join(pair_types,pair_types_info)  
  pair_types_df$pairwise_dist <- as.numeric(pair_types_df$pairwise_dist)
  return(pair_types_df) 
}

update_pair_types_w_info <- function(pair_types_df,df,voi){ 
  # Subset to variables of interest
  df_subset <- df[, c("genomic_id", voi), drop = FALSE]

  # Join on isolate1
  pair_types_df <- pair_types_df %>%
    dplyr::left_join(df_subset, by = c("isolate1" = "genomic_id")) %>%
    dplyr::rename_with(~ paste0(., "1"), .cols = voi)

  # Join on isolate2
  pair_types_df <- pair_types_df %>%
    dplyr::left_join(df_subset, by = c("isolate2" = "genomic_id")) %>%
    dplyr::rename_with(~ paste0(., "2"), .cols = voi)
  
  return(as.data.frame(pair_types_df))
} 
```

## Run the code!
```{r}
voi = c("household",'subject_id','ncbi_id',"visit","collect_date","Species","Species_ST","subject_category",'subject_category_simplified',"subject_type",'index')

pairtype_datasets <- pbmcapply::pbmclapply(species_simple,FUN=function(x){ 
  data <- get(paste0(x,"_data"))
  get_pair_types_mat(data$df,data$mat,type="type",voi=voi)   
}, mc.cores=6) %>% `names<-`(species_simple)

# Overall (Join cause why not and it helps data analysis)
overall_pair_types <- do.call(rbind, pairtype_datasets) 
```

## Save the dataset
```{r} 
saveRDS(overall_pair_types,'./Analysis/Household_transmission/MERLIN-prolonged-colonization-ms/data/SNP_distance/MERLIN_SNP_distance_pairs_dataset.RDS') 
```
