---
title: "Data Cleaning Step 2 - Curate the sequencing [QCD] data"
author: "Kyle Gontjes"
date: "`r Sys.Date()`"
output: html_document
---

Notes:

1. Removed three isolates from consideration on 10/30/25. See section "Drop isolates" for details.

2. See Sequence_data/illumina_fastq folder for QC data and decision-making

```{r setup, include=FALSE}
require(knitr)
opts_knit$set(echo = TRUE,warning = FALSE, message = FALSE)  
opts_knit$set(root.dir='~/Desktop/gl_MERLIN/Analysis/Household_transmission/')
```

# Environment
```{r environment, echo=T, message=FALSE, include=T, results=T}
#Packages
packages <- c("tidyverse")   
#Load Packages
invisible(lapply(packages,library,character.only=T,quietly=T))

# Print environment
set.seed(45) 
Sys.info()
sessionInfo()
```

# Load data
```{r}
master_qc = read.csv("../../Sequence_data/illumina_fastq/master_qc_summary.csv")
colnames(master_qc) <- colnames(master_qc) %>% gsub("\\.|\\.\\.\\.","_",.)
```

# Variable renames
```{r}
# Genomic ID
master_qc$genomic_id <- master_qc$Sample
# Pass QC
master_qc$qc_pass <- ifelse(master_qc$QC_Check=='PASS', TRUE, FALSE) 
# Genus
master_qc$Genus <- str_split(master_qc$Species," ",simplify=T) %>% .[,1]
# Sequence type (ST)
master_qc$ST <- ifelse(master_qc$ST =="-","Unknown",master_qc$ST) 
# Species + ST
master_qc$Species_ST <- paste0(master_qc$Species," ST ",master_qc$ST) %>% trimws(.,"both")
```

# ESCrE WGS Call
```{r}
escre_species_calls <- read_csv("../data/INTEGRATE_MERLIN_WGS_Species_calls_030925_LLC.csv") 
escre_list <- c(escre_species_calls %>% subset(Enterobacterales ==T)%>% .$Species,"Kluyvera sichuanensis")
escre_list

master_qc$WGS_escre <- ifelse(master_qc$Species %in% escre_list,T,F)
```

# Get the specimen's sequencing run  
```{r}
run_11270_ES <- read.csv('../../Sequence_data/illumina_fastq/2025-03-04_11270-ES/DemuxStats_11270-ES.csv') %>% subset(grepl("MERLIN",Description))%>% mutate(run = '11270-ES')
run_9200_LL <- read.csv('../../Sequence_data/illumina_fastq/2025-03-04_9200-LL/DemuxStats_9200-LL_updated.csv') %>% mutate(run = '9200-LL')
run_9200_LL_PurePlex <- read.csv('../../Sequence_data/illumina_fastq/2025-03-04_9200-LL_PurePlex/DemuxStats_9200-LL.csv')%>% mutate(run = '9200-LL_PurePlex')
run_9200_LL_PurePlex_test <- read.csv('../../Sequence_data/illumina_fastq/2025-03-04_9200-LL_PurePlex_test/DemuxStats_9200-LL.csv')%>% mutate(run = '9200_LL_PurePlex_test')
 
sequencing_run_records <- rbind(run_11270_ES,run_9200_LL,run_9200_LL_PurePlex,run_9200_LL_PurePlex_test)

get_sequencing_run <- function(isolate,sequencing_record){
  isolate_hits <- subset(sequencing_record,Description == isolate)
  if(nrow(isolate_hits)>1){
    project = paste0(isolate_hits$run,collapse=";")
  } else {
     project = isolate_hits$run
  }
  return(project)
}

master_qc$sequencing_run <- sapply(master_qc$Sample,get_sequencing_run,sequencing_run_records)
``` 

# Drop isolates
## As of 10/30/25: Drop MERLIN_285, MERLIN_246, and MERLIN_231
### MERLIN_285 - S-221005-00370 - Transcription error which could not be resolved.
### MERLIN_246 - S-221019-01336 - Based on plate map review and sequencing results, this is a duplicate of genomic_id MERLIN_211. Removed MELRIN_246 in preference of MERLIN_211. Needed to change the MERLIN_remove_duplicates file to reflect this...
### MERLIN_231 - S-221221-00536 - Based on LV review and sequencing results, this is a duplicate of genomic_id MERLIN_250.
```{r}
paste0("Number of qc entries at this stage: ",nrow(master_qc))
# Remove these three isolates
isolates_to_drop <- c("MERLIN_285","MERLIN_246","MERLIN_231")
paste0("Dropping the following entries:")
master_qc$genomic_id[master_qc$genomic_id %in% isolates_to_drop]
master_qc <- subset(master_qc,!genomic_id %in% isolates_to_drop)

# Count after removal
paste0("Number of qc entries at this stage: ",nrow(master_qc))
```

# Save the data
```{r}
# All
saveRDS(master_qc,"./MERLIN-prolonged-colonization-ms/data/QCD/master_qc_all.RDS")

# QC passing and not negative controls
master_qc_passing <- subset(master_qc,qc_pass == T & grepl("NEG_CTL",genomic_id) == F)
saveRDS(master_qc_passing,"./MERLIN-prolonged-colonization-ms/data/QCD/master_qc_passing.RDS")
``` 