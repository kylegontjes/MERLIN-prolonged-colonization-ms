---
title: "Supplemental Figure 1: Pairwise distance comparisons by participant"
author: "Kyle Gontjes"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
require(knitr)
opts_knit$set(echo = T,warning = FALSE, message = FALSE,error=F,comment=NA) 
opts_chunk$set(echo = T,warning = FALSE, message = FALSE,error=F,comment=NA)
opts_knit$set(root.dir='~/Desktop/gl_merlin/Analysis/Household_transmission/MERLIN-prolonged-colonization-ms/')
```
 
# Environment

```{r environment, echo=T, message=FALSE, include=T, results=T}
#Packages
packages <- c("tidyverse",'ggplot2','gridExtra') 

#Load Packages
invisible(lapply(packages,library,character.only=T,quietly=T))

# Scripts
source("./lib/consistent_themes.R")

# Print environment
set.seed(45) 
Sys.info()
sessionInfo()
``` 

# Load data
```{r}
df_index <- readRDS("./data/dataset/MERLIN_cohort_index_cases_metadata_final.RDS")
overall_pair_types <- readRDS("./data/SNP_distance/MERLIN_SNP_distance_pairs_dataset.RDS") 
```

# Update pairtypes with the following questions
```{r}
update_pair_types_df_w_questions <- function(pair_types_df){
  both_index_cases <- ifelse(pair_types_df$index1==T & pair_types_df$index2==T,T,F)
  index_isolates <- ifelse(pair_types_df$visit1==0 & pair_types_df$visit2==0,T,F)
  same_household <- ifelse(pair_types_df$household1==pair_types_df$household2,T,F)
  same_household_visit <- ifelse(pair_types_df$household1==pair_types_df$household2 & pair_types_df$visit1==pair_types_df$visit2,T,F) 
  same_individual <- ifelse(pair_types_df$ncbi_id1==pair_types_df$ncbi_id2,T,F)
  ST_pair <- ifelse(pair_types_df$Species_ST1==pair_types_df$Species_ST2,T,F)
  same_specimen_category <- ifelse(pair_types_df$subject_type1 ==pair_types_df$subject_type2,T,F)
  both_human <- ifelse(pair_types_df$subject_type1 == "Human" & pair_types_df$subject_type2 == "Human",T,F)
  both_pet <- ifelse(pair_types_df$subject_type1 == "Pet" & pair_types_df$subject_type2 == "Pet",T,F)
  both_env <- ifelse(pair_types_df$subject_type1 == "Environment" & pair_types_df$subject_type2 == "Environment",T,F)  
  
  dataset <- cbind(pair_types_df,both_index_cases=both_index_cases,index_isolates=index_isolates,same_household=same_household,same_household_visit=same_household_visit,ST_pair=ST_pair,same_specimen_category=same_specimen_category,same_individual=same_individual,both_human=both_human,both_pet=both_pet,both_env=both_env)
  return(dataset)
}
```

# Annotate and subset database
```{r,fig.width=8,fig.height=5}
# Annotate
overall_pair_types <- overall_pair_types %>% update_pair_types_df_w_questions 

# Subset to index isolates
overall_pair_types_index <- subset(overall_pair_types,ncbi_id1 %in%  df_index$ncbi_id & ncbi_id2 %in% df_index$ncbi_id)
```

# Figure
```{r,fig.width=8,fig.height=5}
overall_pair_types_index <- as.data.frame(overall_pair_types_index)
overall_pair_types_index$pairwise_dist <- as.numeric(overall_pair_types_index$pairwise_dist)

# Overall figure
s_figure_1 <- ggplot(data=overall_pair_types_index,aes(x=pairwise_dist,fill=same_household)) + geom_histogram(bins=100) + xlab("Pairwise SNP distance") + ylab("Number of pairs") + theme_bw_me + pairtype_fill  + s_figure_1_format + scale_y_continuous(breaks = c(0,100,200,300,400,500,600,700,800)) + scale_x_continuous(breaks = c(0,10000,25000,50000,75000,100000,125000,150000),limits = c(NA,150010))
s_figure_1

# Insert of 0 to 500
s_figure_1_inlet <- ggplot(data=overall_pair_types_index %>% subset(pairwise_dist <500),aes(x=pairwise_dist,fill=same_household)) + geom_histogram(bins=100) + theme_bw_me + xlab("") + ylab("") + pairtype_fill + geom_vline(xintercept = 25,colour = 'red',linetype = 2) + s_figure_1_inset_format  + scale_x_continuous(breaks = c(0,25,50,75,100,150,200,250,300,350))
s_figure_1_inlet

s_figure_1 <- s_figure_1 +  annotation_custom(ggplotGrob(s_figure_1_inlet), xmin = 60000, xmax = 155000, ymin = 100, ymax = 800)

s_figure_1
```

# Save figure
```{r}
ggsave(plot = s_figure_1,filename = './figures/s_figure_1_pairwise_SNP_distance.png', dpi = 900, width = 8, height = 5,bg='white')
```